name: Load S3 to Supabase

on:
  workflow_dispatch:
    inputs:
      source:
        description: 'Source to load (e.g., york_buildings, york_addresses, or "all")'
        required: true
        default: 'all'
  
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

jobs:
  load:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - run: pip install psycopg2-binary boto3
      
      - name: Load from S3 to Supabase
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
        run: |
          python s3_to_supabase_loader.py --source "${{ github.event.inputs.source || 'all' }}"
