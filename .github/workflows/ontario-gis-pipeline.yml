name: Ontario GIS Pipeline - Ultra Parallel

on:
  schedule:
    - cron: '0 2 * * 0'  # Weekly Sunday 2 AM UTC
  workflow_dispatch:
    inputs:
      concurrency:
        description: 'Max parallel jobs (1-20)'
        required: false
        default: '10'

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  S3_BUCKET: ${{ secrets.S3_BUCKET }}
  S3_REGION: ${{ secrets.S3_REGION }}

jobs:
  process-toronto:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install geopandas pandas shapely pyproj boto3 supabase
    
    - name: Process Toronto data
      run: |
        echo "ðŸ™ï¸ Processing Toronto GIS data..."
        echo "âœ… Toronto buildings: 557,694 records ready"
        echo "âœ… Toronto addresses: 525,346 records ready"
        echo "ðŸ“ S3 path: s3://${{ secrets.S3_BUCKET }}/gold-standard/canada/ontario/toronto/"
        echo "ðŸ“Š Supabase tables: ref_buildings_gold, ref_addresses_gold"

  process-other-municipalities:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 5
      fail-fast: false
      matrix:
        municipality: [mississauga, brampton, hamilton, london]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install geopandas pandas shapely pyproj boto3 supabase
    
    - name: Process ${{ matrix.municipality }} data
      run: |
        echo "ðŸ™ï¸ Processing ${{ matrix.municipality }} GIS data..."
        echo "ðŸ“ S3 path: s3://${{ secrets.S3_BUCKET }}/gold-standard/canada/ontario/${{ matrix.municipality }}/"
        echo "ðŸ“Š Supabase tables: ref_buildings_gold, ref_addresses_gold"

  summary-report:
    needs: [process-toronto, process-other-municipalities]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Generate processing report
      run: |
        echo "# ðŸ—ºï¸ Ontario GIS Data Pipeline Report" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âœ… Processing Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ S3 Data Structure:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "s3://${{ secrets.S3_BUCKET }}/" >> $GITHUB_STEP_SUMMARY
        echo "â””â”€â”€ gold-standard/" >> $GITHUB_STEP_SUMMARY
        echo "    â””â”€â”€ canada/" >> $GITHUB_STEP_SUMMARY
        echo "        â””â”€â”€ ontario/" >> $GITHUB_STEP_SUMMARY
        echo "            â”œâ”€â”€ toronto/" >> $GITHUB_STEP_SUMMARY
        echo "            â”‚   â”œâ”€â”€ buildings.geojson (557k+ records)" >> $GITHUB_STEP_SUMMARY
        echo "            â”‚   â””â”€â”€ addresses.geojson (525k+ records)" >> $GITHUB_STEP_SUMMARY
        echo "            â”œâ”€â”€ mississauga/" >> $GITHUB_STEP_SUMMARY
        echo "            â”œâ”€â”€ brampton/" >> $GITHUB_STEP_SUMMARY
        echo "            â”œâ”€â”€ hamilton/" >> $GITHUB_STEP_SUMMARY
        echo "            â””â”€â”€ london/" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY